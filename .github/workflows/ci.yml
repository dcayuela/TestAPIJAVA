name: CI - Vagrant Hyper-V Docker Rootless

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  vagrant-test:
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Installer Chocolatey et Vagrant, lancer la VM, et vérifier Docker
      - name: Setup Vagrant, Docker rootless & Compose
        shell: pwsh
        run: |
          # Installer Chocolatey si nécessaire
          if (-Not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }

          # Installer Vagrant
          choco install vagrant -y

          # Ajouter le chemin Chocolatey au PATH pour cette session
          $env:Path += ";$env:ALLUSERSPROFILE\chocolatey\bin"

          # Vérifier que Vagrant est installé
          Write-Host "Vagrant version:"
          vagrant --version

          # Lancer la VM Hyper-V avec provisionnement
          vagrant up --provider=hyperv --provision

          # Vérifier Docker rootless
          Write-Host "Docker info:"
          vagrant ssh -c "docker info | grep Rootless"

          # Vérifier Docker Compose V2
          Write-Host "Docker Compose version:"
          vagrant ssh -c "docker compose version"

          # Test rapide : lancer un container hello-world
          Write-Host "Running hello-world container:"
          vagrant ssh -c "docker run --rm hello-world"

      # 3️⃣ Détruire la VM à la fin pour nettoyage
      - name: Destroy VM
        if: always()
        shell: pwsh
        run: |
          $env:Path += ";$env:ALLUSERSPROFILE\chocolatey\bin"
          vagrant destroy -f
